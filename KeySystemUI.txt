local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local KeySystemUI = {}

function KeySystemUI.createUI(callbacks, config)
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "KeySystemUI"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 300, 0, 200)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 8)
    mainCorner.Parent = mainFrame

    -- Title
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -40, 0, 30)
    title.Position = UDim2.new(0, 10, 0, 5)
    title.BackgroundTransparency = 1
    title.Text = "Key System"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextScaled = true
    title.Font = Enum.Font.SourceSansBold
    title.Parent = mainFrame

    -- Close Button
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -30, 0, 5)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextScaled = true
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.BorderSizePixel = 0
    closeButton.Parent = mainFrame

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton

    -- Key Input
    local keyInput = Instance.new("TextBox")
    keyInput.Name = "KeyInput"
    keyInput.Size = UDim2.new(1, -20, 0, 30)
    keyInput.Position = UDim2.new(0, 10, 0, 50)
    keyInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    keyInput.Text = ""
    keyInput.PlaceholderText = "Enter Key"
    keyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    keyInput.TextScaled = true
    keyInput.Font = Enum.Font.SourceSans
    keyInput.BorderSizePixel = 0
    keyInput.Parent = mainFrame

    local keyCorner = Instance.new("UICorner")
    keyCorner.CornerRadius = UDim.new(0, 4)
    keyCorner.Parent = keyInput

    -- Get Key Button
    local getKeyButton = Instance.new("TextButton")
    getKeyButton.Name = "GetKeyButton"
    getKeyButton.Size = UDim2.new(1, -20, 0, 30)
    getKeyButton.Position = UDim2.new(0, 10, 0, 90)
    getKeyButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
    getKeyButton.Text = "Get Key"
    getKeyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    getKeyButton.TextScaled = true
    getKeyButton.Font = Enum.Font.SourceSansBold
    getKeyButton.BorderSizePixel = 0
    getKeyButton.Parent = mainFrame

    local getKeyCorner = Instance.new("UICorner")
    getKeyCorner.CornerRadius = UDim.new(0, 4)
    getKeyCorner.Parent = getKeyButton

    -- Submit Button
    local submitButton = Instance.new("TextButton")
    submitButton.Name = "SubmitButton"
    submitButton.Size = UDim2.new(1, -20, 0, 30)
    submitButton.Position = UDim2.new(0, 10, 0, 130)
    submitButton.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
    submitButton.Text = "Submit"
    submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitButton.TextScaled = true
    submitButton.Font = Enum.Font.SourceSansBold
    submitButton.BorderSizePixel = 0
    submitButton.Parent = mainFrame

    local submitCorner = Instance.new("UICorner")
    submitCorner.CornerRadius = UDim.new(0, 4)
    submitCorner.Parent = submitButton

    -- Status Label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Size = UDim2.new(1, -20, 0, 20)
    statusLabel.Position = UDim2.new(0, 10, 0, 170)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "Enter your key"
    statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    statusLabel.TextScaled = true
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.Parent = mainFrame

    return {
        screenGui = screenGui,
        mainFrame = mainFrame,
        statusLabel = statusLabel,
        keyInput = keyInput,
        getKeyButton = getKeyButton,
        submitButton = submitButton,
        closeButton = closeButton
    }
end

function KeySystemUI.init(callbacks)
    local ui = KeySystemUI.createUI(callbacks, callbacks.config)
    
    -- Close button
    ui.closeButton.MouseButton1Click:Connect(function()
        ui.screenGui:Destroy()
    end)

    -- Get key button
    ui.getKeyButton.MouseButton1Click:Connect(function()
        local success, url = callbacks.openKeyLink()
        if success then
            ui.statusLabel.Text = "Link copied to clipboard"
            ui.statusLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
        else
            ui.statusLabel.Text = "Check console for link"
            ui.statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            print("Link: " .. url)
        end
    end)

    -- Submit button
    ui.submitButton.MouseButton1Click:Connect(function()
        local inputKey = ui.keyInput.Text
        
        if inputKey == "" then
            ui.statusLabel.Text = "Please enter a key"
            ui.statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            return
        end
        
        local isValid = callbacks.validateKey(inputKey)
        
        if isValid then
            ui.statusLabel.Text = "Valid key! Loading script..."
            ui.statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            
            local success, result = callbacks.executeScript()
            
            if success then
                ui.statusLabel.Text = "Script loaded successfully!"
                ui.statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                wait(2)
                ui.screenGui:Destroy()
            else
                ui.statusLabel.Text = "Script failed to load"
                ui.statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
        else
            ui.statusLabel.Text = "Invalid key"
            ui.statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end)

    -- Enter key to submit
    ui.keyInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            ui.submitButton.MouseButton1Click:Fire()
        end
    end)
end

return KeySystemUI
