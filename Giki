local AureKillModule = {}

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local auraEnabled = false
local auraRadius = 45
local damageAmount = 50

-- Check if the model is a player's character
local function isPlayerModel(model)
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Character == model then
			return true
		end
	end
	return false
end

-- Checks and removes dangerous local Animator scripts
local function removeAnimatorScript(model)
	for _, child in ipairs(model:GetChildren()) do
		if child:IsA("LocalScript") or child:IsA("Script") then
			local success, src = pcall(function()
				return child.Source
			end)
			if success and src and src:find("Animator") and src:find("Destroy") and src:find("Health") then
				child:Destroy()
				warn("ðŸ§¹ Removed bad Animator script from:", model:GetFullName())
			end
		end
	end
end

-- Add an Animator to the NPC if missing
local function ensureAnimator(model)
	local humanoid = model:FindFirstChildWhichIsA("Humanoid")
	if humanoid then
		removeAnimatorScript(model) -- Make sure no scripts destroy Animator
		if not humanoid:FindFirstChildOfClass("Animator") then
			local animator = Instance.new("Animator")
			animator.Name = "AuraAnimator"
			animator.Parent = humanoid
			print("âœ… Animator added to:", model.Name)
		end
	end
end

-- Collect all supported NPCs across the defined structure
local function collectNPCModels()
	local npcModels = {}

	-- NightEnemies
	local nightFolder = Workspace:FindFirstChild("NightEnemies")
	if nightFolder then
		for _, model in ipairs(nightFolder:GetChildren()) do
			table.insert(npcModels, model)
		end
	end

	-- Animals under Baseplates > Baseplate > CenterBaseplate > Animals
	local baseplates = Workspace:FindFirstChild("Baseplates")
	if baseplates then
		local baseplate = baseplates:FindFirstChild("Baseplate")
		if baseplate then
			local center = baseplate:FindFirstChild("CenterBaseplate")
			if center then
				local animals = center:FindFirstChild("Animals")
				if animals then
					for _, model in ipairs(animals:GetChildren()) do
						table.insert(npcModels, model)
					end
				end
			end
		end
	end

	-- Zombies inside RandomBuildings > [Any Building] > [Descendants] > Zombies Folder
	local buildings = Workspace:FindFirstChild("RandomBuildings")
	if buildings then
		for _, building in ipairs(buildings:GetChildren()) do
			for _, descendant in ipairs(building:GetDescendants()) do
				if descendant:IsA("Folder") and descendant.Name == "Zombies" then
					for _, model in ipairs(descendant:GetChildren()) do
						table.insert(npcModels, model)
					end
				end
			end
		end
	end

	-- Zombies inside Towns > [Town] > [Descendants] > Zombies Folder
	local towns = Workspace:FindFirstChild("Towns")
	if towns then
		for _, town in ipairs(towns:GetChildren()) do
			for _, descendant in ipairs(town:GetDescendants()) do
				if descendant:IsA("Folder") and descendant.Name == "Zombies" then
					for _, model in ipairs(descendant:GetChildren()) do
						table.insert(npcModels, model)
					end
				end
			end
		end
	end

	return npcModels
end

-- Aura kill loop
local function startAura()
	auraEnabled = true
	task.spawn(function()
		while auraEnabled do
			local character = LocalPlayer.Character
			if character and character:FindFirstChild("HumanoidRootPart") then
				local root = character.HumanoidRootPart
				local npcModels = collectNPCModels()

				for _, model in ipairs(npcModels) do
					if model:IsA("Model") and model:FindFirstChild("Humanoid") and model:FindFirstChild("HumanoidRootPart") and not isPlayerModel(model) then
						local dist = (model.HumanoidRootPart.Position - root.Position).Magnitude
						if dist <= auraRadius and model.Humanoid.Health > 0 then
							ensureAnimator(model)
							model.Humanoid:TakeDamage(damageAmount)
							print("ðŸ’¥ Damaged:", model.Name, "->", model.Humanoid.Health)
						end
					end
				end
			end
			task.wait(0.5)
		end
	end)
end

-- Stop aura
local function stopAura()
	auraEnabled = false
end

-- Public toggle
function AureKillModule.toggleAura(state)
	if state then
		startAura()
	else
		stopAura()
	end
end

return AureKillModule
