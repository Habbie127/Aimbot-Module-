-- ESPModule.lua
local ESPModule = {}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ESPFolder = Instance.new("Folder", workspace)
ESPFolder.Name = "ESP_Objects"

local settings = {
    Highlight = false,
    Name = false,
    Distance = false,
    MaxDistance = 300
}

local function createBillboard(name, distance)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP_Billboard"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true

    local label = Instance.new("TextLabel", billboard)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.TextScaled = true
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextStrokeTransparency = 0.5
    label.Font = Enum.Font.SourceSansBold
    label.Text = name .. (settings.Distance and (" | " .. math.floor(distance) .. "m") or "")

    return billboard
end

local function updateESP()
    for _, v in pairs(ESPFolder:GetChildren()) do
        v:Destroy()
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = player.Character.HumanoidRootPart
            local distance = (Camera.CFrame.Position - rootPart.Position).Magnitude

            if distance <= settings.MaxDistance then
                local container = Instance.new("Folder", ESPFolder)
                container.Name = player.Name .. "_ESP"

                if settings.Highlight then
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = player.Character
                    highlight.FillColor = Color3.fromRGB(0, 255, 0)
                    highlight.OutlineColor = Color3.new(0, 0, 0)
                    highlight.FillTransparency = 0.5
                    highlight.OutlineTransparency = 0
                    highlight.Parent = container
                end

                if settings.Name or settings.Distance then
                    local tag = createBillboard(player.Name, distance)
                    tag.Adornee = rootPart
                    tag.Parent = container
                end
            end
        end
    end
end

function ESPModule.SetSettings(newSettings)
    for k, v in pairs(newSettings) do
        if settings[k] ~= nil then
            settings[k] = v
        end
    end
end

function ESPModule.Enable()
    ESPModule.Connection = RunService.RenderStepped:Connect(updateESP)
end

function ESPModule.Disable()
    if ESPModule.Connection then
        ESPModule.Connection:Disconnect()
        ESPModule.Connection = nil
    end
    ESPFolder:ClearAllChildren()
end

return ESPModule
